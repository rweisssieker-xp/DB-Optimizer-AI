<Window x:Class="DBOptimizer.WpfApp.Dialogs.AiExplainerDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="AI Query Explainer"
        Height="800" Width="1100"
        WindowStartupLocation="CenterOwner"
        Background="#F5F5F5"
        ResizeMode="CanResize"
        ShowInTaskbar="False">

    <Window.Resources>
        <!-- Modern Button Style -->
        <Style x:Key="ModernButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="#2196F3"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="20,10"/>
            <Setter Property="FontSize" Value="14"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center"
                                            VerticalAlignment="Center"/>
                        </Border>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
            <Style.Triggers>
                <Trigger Property="IsMouseOver" Value="True">
                    <Setter Property="Background" Value="#1976D2"/>
                </Trigger>
                <Trigger Property="IsEnabled" Value="False">
                    <Setter Property="Background" Value="#BDBDBD"/>
                    <Setter Property="Cursor" Value="Arrow"/>
                </Trigger>
            </Style.Triggers>
        </Style>

        <!-- Score Badge Style -->
        <Style x:Key="ScoreBadge" TargetType="Border">
            <Setter Property="CornerRadius" Value="20"/>
            <Setter Property="Padding" Value="12,6"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
        </Style>

        <!-- Section Card Style -->
        <Style x:Key="SectionCard" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="20"/>
            <Setter Property="Margin" Value="0,0,0,16"/>
        </Style>
    </Window.Resources>

    <!-- Fade-in animation -->
    <Window.Triggers>
        <EventTrigger RoutedEvent="Loaded">
            <BeginStoryboard>
                <Storyboard>
                    <DoubleAnimation Storyboard.TargetProperty="Opacity"
                                   From="0" To="1" Duration="0:0:0.3"/>
                </Storyboard>
            </BeginStoryboard>
        </EventTrigger>
    </Window.Triggers>

    <Grid>
        <!-- Main Container -->
        <Border Background="White"
                CornerRadius="8"
                Margin="20">
            <Border.Effect>
                <DropShadowEffect Color="#000000"
                                BlurRadius="20"
                                ShadowDepth="2"
                                Opacity="0.2"
                                Direction="270"/>
            </Border.Effect>

            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <!-- Header with Score -->
                <Border Grid.Row="0"
                        CornerRadius="8,8,0,0"
                        Padding="24,20">
                    <Border.Background>
                        <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                            <GradientStop Color="#667eea" Offset="0"/>
                            <GradientStop Color="#764ba2" Offset="1"/>
                        </LinearGradientBrush>
                    </Border.Background>

                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Title Section -->
                        <StackPanel Grid.Column="0">
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="ðŸ¤–"
                                         FontSize="32"
                                         VerticalAlignment="Center"
                                         Margin="0,0,16,0"/>
                                <StackPanel>
                                    <TextBlock Text="AI Query Explainer"
                                             FontSize="24"
                                             FontWeight="Bold"
                                             Foreground="White"/>
                                    <TextBlock Text="{Binding Summary}"
                                             FontSize="14"
                                             Foreground="#E0E0E0"
                                             TextWrapping="Wrap"
                                             Margin="0,8,0,0"/>
                                </StackPanel>
                            </StackPanel>
                        </StackPanel>

                        <!-- Performance Score Badge -->
                        <StackPanel Grid.Column="1"
                                  VerticalAlignment="Center">
                            <Border Style="{StaticResource ScoreBadge}"
                                  Background="{Binding ScoreColor}">
                                <StackPanel>
                                    <TextBlock Text="{Binding PerformanceScore}"
                                             FontSize="32"
                                             FontWeight="Bold"
                                             Foreground="White"
                                             HorizontalAlignment="Center"/>
                                    <TextBlock Text="/ 100"
                                             FontSize="14"
                                             Foreground="White"
                                             HorizontalAlignment="Center"
                                             Margin="0,-8,0,0"/>
                                    <TextBlock Text="{Binding PerformanceRating}"
                                             FontSize="12"
                                             FontWeight="SemiBold"
                                             Foreground="White"
                                             HorizontalAlignment="Center"
                                             Margin="0,4,0,0"/>
                                </StackPanel>
                            </Border>
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Content Area with Tabs -->
                <TabControl Grid.Row="1"
                          Padding="24,20"
                          Background="Transparent"
                          BorderThickness="0">

                    <!-- Problems Tab -->
                    <TabItem Header="ðŸ” Problems" FontSize="14" FontWeight="SemiBold">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel>
                                <TextBlock Text="Performance Issues Detected"
                                         FontSize="18"
                                         FontWeight="Bold"
                                         Foreground="#212121"
                                         Margin="0,0,0,16"/>

                                <ItemsControl ItemsSource="{Binding Problems}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Style="{StaticResource SectionCard}">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="*"/>
                                                    </Grid.ColumnDefinitions>

                                                    <!-- Icon -->
                                                    <TextBlock Grid.Column="0"
                                                             Text="{Binding Icon}"
                                                             FontSize="32"
                                                             VerticalAlignment="Top"
                                                             Margin="0,0,16,0"/>

                                                    <!-- Content -->
                                                    <StackPanel Grid.Column="1">
                                                        <StackPanel Orientation="Horizontal">
                                                            <Border Background="#F44336"
                                                                  CornerRadius="3"
                                                                  Padding="8,4"
                                                                  Margin="0,0,12,0">
                                                                <TextBlock Text="{Binding Severity}"
                                                                         FontSize="11"
                                                                         FontWeight="Bold"
                                                                         Foreground="White"/>
                                                            </Border>
                                                            <TextBlock Text="{Binding Title}"
                                                                     FontSize="16"
                                                                     FontWeight="Bold"
                                                                     Foreground="#212121"/>
                                                        </StackPanel>

                                                        <TextBlock Text="{Binding Explanation}"
                                                                 FontSize="14"
                                                                 Foreground="#424242"
                                                                 TextWrapping="Wrap"
                                                                 Margin="0,12,0,0"
                                                                 LineHeight="22"/>

                                                        <Border Background="#FFF9C4"
                                                              CornerRadius="4"
                                                              Padding="12"
                                                              Margin="0,12,0,0">
                                                            <StackPanel>
                                                                <TextBlock Text="ðŸ’¡ Why this matters:"
                                                                         FontSize="12"
                                                                         FontWeight="SemiBold"
                                                                         Foreground="#F57C00"/>
                                                                <TextBlock Text="{Binding Why}"
                                                                         FontSize="13"
                                                                         Foreground="#424242"
                                                                         TextWrapping="Wrap"
                                                                         Margin="0,4,0,0"/>
                                                            </StackPanel>
                                                        </Border>

                                                        <Border Background="#E3F2FD"
                                                              CornerRadius="4"
                                                              Padding="12"
                                                              Margin="0,8,0,0">
                                                            <StackPanel>
                                                                <TextBlock Text="ðŸ“– Analogy:"
                                                                         FontSize="12"
                                                                         FontWeight="SemiBold"
                                                                         Foreground="#1976D2"/>
                                                                <TextBlock Text="{Binding Analogy}"
                                                                         FontSize="13"
                                                                         Foreground="#424242"
                                                                         TextWrapping="Wrap"
                                                                         Margin="0,4,0,0"
                                                                         FontStyle="Italic"/>
                                                            </StackPanel>
                                                        </Border>

                                                        <TextBlock Text="{Binding Impact}"
                                                                 FontSize="13"
                                                                 Foreground="#F44336"
                                                                 FontWeight="SemiBold"
                                                                 Margin="0,12,0,0"/>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                                <!-- No problems -->
                                <Border Style="{StaticResource SectionCard}"
                                      Visibility="{Binding HasNoProblems, Converter={StaticResource BooleanToVisibilityConverter}}">
                                    <StackPanel HorizontalAlignment="Center"
                                              Margin="40">
                                        <TextBlock Text="âœ…"
                                                 FontSize="48"
                                                 HorizontalAlignment="Center"/>
                                        <TextBlock Text="No Critical Issues Found"
                                                 FontSize="18"
                                                 FontWeight="SemiBold"
                                                 Foreground="#4CAF50"
                                                 HorizontalAlignment="Center"
                                                 Margin="0,16,0,8"/>
                                        <TextBlock Text="This query is performing well!"
                                                 FontSize="14"
                                                 Foreground="#757575"
                                                 HorizontalAlignment="Center"/>
                                    </StackPanel>
                                </Border>
                            </StackPanel>
                        </ScrollViewer>
                    </TabItem>

                    <!-- Recommendations Tab -->
                    <TabItem Header="ðŸ’¡ Fix It" FontSize="14" FontWeight="SemiBold">
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel>
                                <Grid Margin="0,0,0,16">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="Recommended Actions"
                                                 FontSize="18"
                                                 FontWeight="Bold"
                                                 Foreground="#212121"/>
                                        <TextBlock Text="Sorted by priority and impact"
                                                 FontSize="13"
                                                 Foreground="#757575"
                                                 Margin="0,4,0,0"/>
                                    </StackPanel>

                                    <Border Grid.Column="1"
                                          Background="#4CAF50"
                                          CornerRadius="4"
                                          Padding="12,8">
                                        <StackPanel Orientation="Horizontal">
                                            <TextBlock Text="ðŸš€"
                                                     FontSize="16"
                                                     Margin="0,0,8,0"/>
                                            <StackPanel>
                                                <TextBlock Text="{Binding EstimatedTotalImprovement}"
                                                         FontSize="18"
                                                         FontWeight="Bold"
                                                         Foreground="White"/>
                                                <TextBlock Text="% faster"
                                                         FontSize="11"
                                                         Foreground="White"
                                                         Margin="0,-4,0,0"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </Border>
                                </Grid>

                                <ItemsControl ItemsSource="{Binding Recommendations}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Style="{StaticResource SectionCard}">
                                                <Grid>
                                                    <Grid.RowDefinitions>
                                                        <RowDefinition Height="Auto"/>
                                                        <RowDefinition Height="*"/>
                                                    </Grid.RowDefinitions>

                                                    <!-- Header -->
                                                    <Grid Grid.Row="0">
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>

                                                        <TextBlock Grid.Column="0"
                                                                 Text="{Binding Icon}"
                                                                 FontSize="24"
                                                                 Margin="0,0,12,0"/>

                                                        <StackPanel Grid.Column="1">
                                                            <TextBlock Text="{Binding Title}"
                                                                     FontSize="16"
                                                                     FontWeight="Bold"
                                                                     Foreground="#212121"/>
                                                            <StackPanel Orientation="Horizontal"
                                                                      Margin="0,4,0,0">
                                                                <Border Background="#9C27B0"
                                                                      CornerRadius="3"
                                                                      Padding="6,3"
                                                                      Margin="0,0,8,0">
                                                                    <TextBlock Text="{Binding Priority}"
                                                                             FontSize="11"
                                                                             FontWeight="Bold"
                                                                             Foreground="White"/>
                                                                </Border>
                                                                <TextBlock Text="{Binding EstimatedImprovement}"
                                                                         FontSize="12"
                                                                         FontWeight="SemiBold"
                                                                         Foreground="#4CAF50"/>
                                                                <TextBlock Text="% faster"
                                                                         FontSize="12"
                                                                         Foreground="#4CAF50"
                                                                         Margin="4,0,0,0"/>
                                                                <TextBlock Text="â€¢"
                                                                         FontSize="12"
                                                                         Foreground="#BDBDBD"
                                                                         Margin="8,0"/>
                                                                <TextBlock Text="{Binding EstimatedTimeMinutes}"
                                                                         FontSize="12"
                                                                         Foreground="#757575"/>
                                                                <TextBlock Text="min"
                                                                         FontSize="12"
                                                                         Foreground="#757575"
                                                                         Margin="4,0,0,0"/>
                                                            </StackPanel>
                                                        </StackPanel>

                                                        <Border Grid.Column="2"
                                                              Background="#E0E0E0"
                                                              CornerRadius="4"
                                                              Padding="8,4">
                                                            <TextBlock Text="{Binding RiskLevel}"
                                                                     FontSize="11"
                                                                     Foreground="#616161"/>
                                                        </Border>
                                                    </Grid>

                                                    <!-- Content -->
                                                    <StackPanel Grid.Row="1"
                                                              Margin="36,12,0,0">
                                                        <TextBlock Text="{Binding Action}"
                                                                 FontSize="14"
                                                                 Foreground="#212121"
                                                                 TextWrapping="Wrap"
                                                                 FontWeight="SemiBold"/>

                                                        <TextBlock Text="{Binding Benefit}"
                                                                 FontSize="13"
                                                                 Foreground="#757575"
                                                                 TextWrapping="Wrap"
                                                                 Margin="0,8,0,0"/>

                                                        <!-- Steps -->
                                                        <TextBlock Text="Implementation Steps:"
                                                                 FontSize="12"
                                                                 FontWeight="SemiBold"
                                                                 Foreground="#212121"
                                                                 Margin="0,12,0,8"/>
                                                        <ItemsControl ItemsSource="{Binding Steps}">
                                                            <ItemsControl.ItemTemplate>
                                                                <DataTemplate>
                                                                    <StackPanel Orientation="Horizontal"
                                                                              Margin="0,0,0,4">
                                                                        <TextBlock Text="âœ“"
                                                                                 FontSize="12"
                                                                                 Foreground="#4CAF50"
                                                                                 Margin="0,0,8,0"/>
                                                                        <TextBlock Text="{Binding Mode=OneWay}"
                                                                                 FontSize="13"
                                                                                 Foreground="#424242"
                                                                                 TextWrapping="Wrap"/>
                                                                    </StackPanel>
                                                                </DataTemplate>
                                                            </ItemsControl.ItemTemplate>
                                                        </ItemsControl>

                                                        <!-- Script Section -->
                                                        <Border Background="#263238"
                                                              CornerRadius="4"
                                                              Padding="12"
                                                              Margin="0,12,0,0"
                                                              Visibility="{Binding HasScript, Converter={StaticResource BooleanToVisibilityConverter}}">
                                                            <Grid>
                                                                <Grid.RowDefinitions>
                                                                    <RowDefinition Height="Auto"/>
                                                                    <RowDefinition Height="Auto"/>
                                                                </Grid.RowDefinitions>

                                                                <Grid Grid.Row="0"
                                                                    Margin="0,0,0,8">
                                                                    <TextBlock Text="SQL Script"
                                                                             FontSize="12"
                                                                             FontWeight="SemiBold"
                                                                             Foreground="#90CAF9"
                                                                             HorizontalAlignment="Left"/>
                                                                    <Button Content="ðŸ“‹ Copy"
                                                                          HorizontalAlignment="Right"
                                                                          Padding="8,4"
                                                                          Background="#455A64"
                                                                          Foreground="White"
                                                                          BorderThickness="0"
                                                                          FontSize="11"
                                                                          Cursor="Hand"
                                                                          Click="CopyScript_Click"
                                                                          Tag="{Binding Script}"/>
                                                                </Grid>

                                                                <TextBox Grid.Row="1"
                                                                       Text="{Binding Script}"
                                                                       FontFamily="Consolas"
                                                                       FontSize="12"
                                                                       Foreground="#C3E88D"
                                                                       Background="Transparent"
                                                                       BorderThickness="0"
                                                                       IsReadOnly="True"
                                                                       TextWrapping="Wrap"
                                                                       MaxHeight="150"
                                                                       VerticalScrollBarVisibility="Auto"/>
                                                            </Grid>
                                                        </Border>
                                                    </StackPanel>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </ScrollViewer>
                    </TabItem>

                    <!-- Ask AI Tab -->
                    <TabItem Header="ðŸ’¬ Ask AI" FontSize="14" FontWeight="SemiBold">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <!-- Instructions -->
                            <Border Grid.Row="0"
                                  Background="#E3F2FD"
                                  CornerRadius="4"
                                  Padding="16"
                                  Margin="0,0,0,16">
                                <StackPanel>
                                    <TextBlock Text="ðŸ’¬ Chat with AI about this query"
                                             FontSize="14"
                                             FontWeight="SemiBold"
                                             Foreground="#1976D2"/>
                                    <TextBlock Text="Ask any question and get instant AI-powered answers!"
                                             FontSize="13"
                                             Foreground="#424242"
                                             Margin="0,4,0,0"/>
                                </StackPanel>
                            </Border>

                            <!-- Conversation Area -->
                            <ScrollViewer Grid.Row="1"
                                        x:Name="ChatScrollViewer"
                                        VerticalScrollBarVisibility="Auto"
                                        Background="White">
                                <ItemsControl ItemsSource="{Binding ChatMessages}"
                                            Padding="16">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border Margin="0,0,0,16"
                                                  Background="{Binding BackgroundColor}"
                                                  CornerRadius="8"
                                                  Padding="12">
                                                <StackPanel>
                                                    <TextBlock Text="{Binding Sender}"
                                                             FontSize="11"
                                                             FontWeight="SemiBold"
                                                             Foreground="{Binding SenderColor}"
                                                             Margin="0,0,0,4"/>
                                                    <TextBlock Text="{Binding Message}"
                                                             FontSize="13"
                                                             Foreground="#212121"
                                                             TextWrapping="Wrap"
                                                             LineHeight="20"/>
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>

                            <!-- Input Area -->
                            <Border Grid.Row="2"
                                  Background="White"
                                  BorderBrush="#E0E0E0"
                                  BorderThickness="0,1,0,0"
                                  Padding="16">
                                <Grid>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto"/>
                                        <RowDefinition Height="Auto"/>
                                    </Grid.RowDefinitions>

                                    <!-- Suggested Questions -->
                                    <ItemsControl Grid.Row="0"
                                                ItemsSource="{Binding SuggestedQuestions}"
                                                Margin="0,0,0,12">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Button Content="{Binding}"
                                                      Margin="0,0,8,8"
                                                      Padding="10,6"
                                                      Background="#F5F5F5"
                                                      Foreground="#1976D2"
                                                      BorderBrush="#E0E0E0"
                                                      BorderThickness="1"
                                                      FontSize="12"
                                                      Cursor="Hand"
                                                      Click="SuggestedQuestion_Click"/>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!-- Text Input -->
                                    <Grid Grid.Row="1">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>

                                        <TextBox Grid.Column="0"
                                               x:Name="QuestionTextBox"
                                               FontSize="14"
                                               Padding="12"
                                               BorderBrush="#E0E0E0"
                                               BorderThickness="1"
                                               Background="White"
                                               Foreground="#212121"
                                               VerticalContentAlignment="Center"
                                               Text="{Binding UserQuestion, UpdateSourceTrigger=PropertyChanged}"
                                               KeyDown="QuestionTextBox_KeyDown"/>

                                        <Button Grid.Column="1"
                                              Content="Ask ðŸš€"
                                              Style="{StaticResource ModernButtonStyle}"
                                              Margin="12,0,0,0"
                                              Padding="20,10"
                                              Click="AskQuestion_Click"
                                              IsEnabled="{Binding CanAskQuestion}"/>
                                    </Grid>
                                </Grid>
                            </Border>
                        </Grid>
                    </TabItem>
                </TabControl>

                <!-- Footer -->
                <Border Grid.Row="2"
                        BorderBrush="#E0E0E0"
                        BorderThickness="0,1,0,0"
                        Padding="24,16"
                        Background="#FAFAFA">
                    <Grid>
                        <StackPanel Orientation="Horizontal"
                                  HorizontalAlignment="Left">
                            <TextBlock Text="ðŸ’°"
                                     FontSize="14"
                                     Margin="0,0,8,0"/>
                            <TextBlock Text="{Binding ROISummary}"
                                     FontSize="13"
                                     Foreground="#757575"
                                     VerticalAlignment="Center"/>
                        </StackPanel>

                        <Button Content="Close"
                              Style="{StaticResource ModernButtonStyle}"
                              HorizontalAlignment="Right"
                              Click="CloseButton_Click"
                              MinWidth="100"/>
                    </Grid>
                </Border>
            </Grid>
        </Border>
    </Grid>
</Window>

