<UserControl x:Class="DBOptimizer.WpfApp.Views.SettingsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             mc:Ignorable="d" 
             d:DesignHeight="600" d:DesignWidth="1200">
    
    <Grid Margin="20">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="300"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>

        <!-- Profiles List -->
        <Border Grid.Column="0" 
               Background="#F5F5F5" 
               BorderBrush="#BDBDBD" 
               BorderThickness="1" 
               CornerRadius="10" 
               Padding="15" 
               Margin="0,0,15,0">
            <StackPanel>
                <TextBlock Text="Connection Profiles" 
                          FontSize="18" 
                          FontWeight="Bold" 
                          Margin="0,0,0,15"/>
                
                <Button Content="âž• New Profile" 
                       Command="{Binding NewProfileCommand}" 
                       Background="#4CAF50" 
                       Foreground="White" 
                       FontWeight="Bold" 
                       BorderThickness="0" 
                       Height="35" 
                       Cursor="Hand" 
                       Margin="0,0,0,10"/>

                <ListBox ItemsSource="{Binding Profiles}"
                        SelectedItem="{Binding SelectedProfile, Mode=TwoWay}"
                        Height="400"
                        BorderThickness="0">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <Border Margin="2" Padding="8" CornerRadius="5">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Background" Value="Transparent"/>
                                        <Style.Triggers>
                                            <DataTrigger Value="True">
                                                <DataTrigger.Binding>
                                                    <MultiBinding Converter="{StaticResource ProfileIsActiveConverter}">
                                                        <Binding Path="Id"/>
                                                        <Binding Path="DataContext.ActiveConnectionProfile" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                    </MultiBinding>
                                                </DataTrigger.Binding>
                                                <Setter Property="Background" Value="#E8F5E9"/>
                                                <Setter Property="BorderBrush" Value="#4CAF50"/>
                                                <Setter Property="BorderThickness" Value="2"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal">
                                        <!-- Active Connection Indicator -->
                                        <Ellipse Width="10" Height="10" Fill="#4CAF50" Margin="0,0,8,0" VerticalAlignment="Center">
                                            <Ellipse.Style>
                                                <Style TargetType="Ellipse">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Value="True">
                                                            <DataTrigger.Binding>
                                                                <MultiBinding Converter="{StaticResource ProfileIsActiveConverter}">
                                                                    <Binding Path="Id"/>
                                                                    <Binding Path="DataContext.ActiveConnectionProfile" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                                </MultiBinding>
                                                            </DataTrigger.Binding>
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </Ellipse.Style>
                                        </Ellipse>

                                        <TextBlock Text="{Binding Name}"
                                                  FontWeight="Bold"
                                                  FontSize="14"/>
                                    </StackPanel>
                                    <TextBlock Text="{Binding SqlServerName}"
                                              FontSize="11"
                                              Foreground="#757575"
                                              Margin="18,0,0,0"/>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </StackPanel>
        </Border>

        <!-- Profile Details -->
        <ScrollViewer Grid.Column="1" VerticalScrollBarVisibility="Auto">
            <StackPanel>
                <TextBlock Text="Profile Details" 
                          FontSize="20" 
                          FontWeight="Bold" 
                          Margin="0,0,0,15"/>

                <!-- Status Message -->
                <Border Background="#E3F2FD" 
                       BorderBrush="#2196F3" 
                       BorderThickness="1" 
                       CornerRadius="5" 
                       Padding="10" 
                       Margin="0,0,0,15"
                       Visibility="{Binding StatusMessage, Converter={StaticResource StringToVisibilityConverter}}">
                    <TextBlock Text="{Binding StatusMessage}" 
                              FontWeight="SemiBold"/>
                </Border>

                <!-- Profile Name -->
                <TextBlock Text="Profile Name" FontWeight="Bold" Margin="0,0,0,5"/>
                <TextBox Text="{Binding SelectedProfile.Name, Mode=TwoWay}" 
                        Margin="0,0,0,15"/>

                <!-- SQL Server Name -->
                <TextBlock Text="SQL Server Name" FontWeight="Bold" Margin="0,0,0,5"/>
                <TextBox Text="{Binding SelectedProfile.SqlServerName, Mode=TwoWay}" 
                        Margin="0,0,0,15"/>

                <!-- Database Name -->
                <TextBlock Text="Database Name" FontWeight="Bold" Margin="0,0,0,5"/>
                <Grid Margin="0,0,0,15">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <ComboBox Grid.Column="0"
                             ItemsSource="{Binding AvailableDatabases}"
                             SelectedItem="{Binding SelectedProfile.DatabaseName, Mode=TwoWay}"
                             IsEditable="True"
                             Margin="0,0,10,0"/>

                    <Button Grid.Column="1"
                           Content="ðŸ”„ Load"
                           Command="{Binding LoadDatabasesCommand}"
                           Background="#2196F3"
                           Foreground="White"
                           FontWeight="Bold"
                           Width="80"
                           Height="30"
                           BorderThickness="0"
                           Cursor="Hand"
                           ToolTip="Load available databases from SQL Server"/>
                </Grid>

                <!-- Windows Authentication -->
                <CheckBox Content="Use Windows Authentication" 
                         IsChecked="{Binding SelectedProfile.UseWindowsAuthentication, Mode=TwoWay}" 
                         Margin="0,0,0,15"/>

                <!-- Username -->
                <TextBlock Text="Username" FontWeight="Bold" Margin="0,0,0,5"/>
                <TextBox Text="{Binding SelectedProfile.Username, Mode=TwoWay}"
                        IsEnabled="{Binding SelectedProfile.UseWindowsAuthentication, Converter={StaticResource InverseBoolConverter}}"
                        Margin="0,0,0,15"/>

                <!-- Password -->
                <TextBlock Text="Password" FontWeight="Bold" Margin="0,0,0,5"/>
                <PasswordBox x:Name="PasswordBox"
                            IsEnabled="{Binding SelectedProfile.UseWindowsAuthentication, Converter={StaticResource InverseBoolConverter}}"
                            Margin="0,0,0,15"/>
                <TextBlock Text="(Leave empty to keep existing password)"
                          FontSize="10"
                          Foreground="#757575"
                          Margin="0,-10,0,15"/>

                <!-- Default Profile -->
                <CheckBox Content="Set as Default Profile" 
                         IsChecked="{Binding SelectedProfile.IsDefault, Mode=TwoWay}" 
                         Margin="0,0,0,20"/>

                <!-- Action Buttons -->
                <WrapPanel>
                    <Button Content="ðŸ’¾ Save" 
                           Command="{Binding SaveProfileCommand}" 
                           Background="#4CAF50" 
                           Foreground="White" 
                           FontWeight="Bold" 
                           Width="120" 
                           Height="35" 
                           BorderThickness="0" 
                           Cursor="Hand"/>
                    
                    <Button Content="ðŸ”Œ Test Connection" 
                           Command="{Binding TestConnectionCommand}" 
                           Background="#2196F3" 
                           Foreground="White" 
                           FontWeight="Bold" 
                           Width="150" 
                           Height="35" 
                           BorderThickness="0" 
                           Cursor="Hand" 
                           Margin="10,0,0,0"/>
                    
                    <Button Content="âœ… Connect" 
                           Command="{Binding ConnectCommand}" 
                           Background="#FF9800" 
                           Foreground="White" 
                           FontWeight="Bold" 
                           Width="120" 
                           Height="35" 
                           BorderThickness="0" 
                           Cursor="Hand" 
                           Margin="10,0,0,0"/>
                    
                    <Button Content="ðŸ—‘ï¸ Delete"
                           Command="{Binding DeleteProfileCommand}"
                           Background="#F44336"
                           Foreground="White"
                           FontWeight="Bold"
                           Width="120"
                           Height="35"
                           BorderThickness="0"
                           Cursor="Hand"
                           Margin="10,0,0,0"/>

                    <Button Content="ðŸ“¤ Export Profiles"
                            Command="{Binding ExportProfilesAsyncCommand}"
                            Background="#607D8B"
                            Foreground="White"
                            FontWeight="Bold"
                            Width="170"
                            Height="35"
                            BorderThickness="0"
                            Cursor="Hand"
                            Margin="10,0,0,0"
                            ToolTip="Export all profiles to Desktop as JSON"/>

                    <Button Content="ðŸ“¥ Import Profiles"
                            Command="{Binding ImportProfilesAsyncCommand}"
                            Background="#455A64"
                            Foreground="White"
                            FontWeight="Bold"
                            Width="170"
                            Height="35"
                            BorderThickness="0"
                            Cursor="Hand"
                            Margin="10,0,0,0"
                            ToolTip="Import profiles from Desktop file DBOptimizerProfiles_Import.json"/>
                </WrapPanel>

                <!-- AI Configuration Section -->
                <Border Background="#F3E5F5"
                       BorderBrush="#9C27B0"
                       BorderThickness="2"
                       CornerRadius="10"
                       Padding="20"
                       Margin="0,40,0,0">
                    <StackPanel>
                        <TextBlock Text="ðŸ¤– AI-Powered Query Optimizer Configuration"
                                  FontSize="20"
                                  FontWeight="Bold"
                                  Foreground="#6A1B9A"
                                  Margin="0,0,0,15"/>

                        <!-- AI Status Message -->
                        <Border Background="#FFFDE7"
                               BorderBrush="#FBC02D"
                               BorderThickness="1"
                               CornerRadius="5"
                               Padding="10"
                               Margin="0,0,0,15"
                               Visibility="{Binding AiStatusMessage, Converter={StaticResource StringToVisibilityConverter}}">
                            <TextBlock Text="{Binding AiStatusMessage}"
                                      TextWrapping="Wrap"
                                      FontWeight="SemiBold"/>
                        </Border>

                        <!-- Enable AI -->
                        <CheckBox Content="Enable AI Features"
                                 IsChecked="{Binding IsAiEnabled, Mode=TwoWay}"
                                 FontWeight="Bold"
                                 FontSize="14"
                                 Margin="0,0,0,15"/>

                        <!-- Provider Selection -->
                        <TextBlock Text="AI Provider" FontWeight="Bold" Margin="0,0,0,5"/>
                        <ComboBox ItemsSource="{Binding AiProviders}"
                                 SelectedItem="{Binding AiProvider, Mode=TwoWay}"
                                 IsEnabled="{Binding IsAiEnabled}"
                                 Margin="0,0,0,15"/>

                        <!-- API Key -->
                        <TextBlock Text="API Key" FontWeight="Bold" Margin="0,0,0,5"/>
                        <TextBox Text="{Binding AiApiKey, Mode=TwoWay}"
                                IsEnabled="{Binding IsAiEnabled}"
                                Margin="0,0,0,5"/>
                        <TextBlock Text="Get your API key from platform.openai.com/api-keys (for OpenAI) or Azure Portal (for Azure OpenAI)"
                                  FontSize="10"
                                  Foreground="#757575"
                                  TextWrapping="Wrap"
                                  Margin="0,0,0,15"/>

                        <!-- Endpoint -->
                        <TextBlock Text="API Endpoint" FontWeight="Bold" Margin="0,0,0,5"/>
                        <TextBox Text="{Binding AiEndpoint, Mode=TwoWay}"
                                IsEnabled="{Binding IsAiEnabled}"
                                Margin="0,0,0,5"/>
                        <TextBlock Text="OpenAI: https://api.openai.com | Azure: https://YOUR-RESOURCE.openai.azure.com"
                                  FontSize="10"
                                  Foreground="#757575"
                                  TextWrapping="Wrap"
                                  Margin="0,0,0,15"/>

                        <!-- Model -->
                        <TextBlock Text="Model" FontWeight="Bold" Margin="0,0,0,5"/>
                        <ComboBox ItemsSource="{Binding AiModels}"
                                 SelectedItem="{Binding AiModel, Mode=TwoWay}"
                                 IsEnabled="{Binding IsAiEnabled}"
                                 Margin="0,0,0,5"/>
                        <TextBlock Text="gpt-4o: Best balance | gpt-4: Highest quality | gpt-3.5-turbo: Cheapest"
                                  FontSize="10"
                                  Foreground="#757575"
                                  TextWrapping="Wrap"
                                  Margin="0,0,0,20"/>

                        <!-- AI Action Buttons -->
                        <WrapPanel>
                            <Button Content="ðŸ’¾ Save AI Config"
                                   Command="{Binding SaveAiConfigurationCommand}"
                                   Background="#9C27B0"
                                   Foreground="White"
                                   FontWeight="Bold"
                                   Width="150"
                                   Height="35"
                                   BorderThickness="0"
                                   Cursor="Hand"
                                   IsEnabled="{Binding IsAiEnabled}"/>

                            <Button Content="ðŸ§ª Test Config"
                                   Command="{Binding TestAiConfigurationCommand}"
                                   Background="#673AB7"
                                   Foreground="White"
                                   FontWeight="Bold"
                                   Width="130"
                                   Height="35"
                                   BorderThickness="0"
                                   Cursor="Hand"
                                   Margin="10,0,0,0"
                                   IsEnabled="{Binding IsAiEnabled}"/>
                        </WrapPanel>

                        <!-- Info Box -->
                        <Border Background="#E1F5FE"
                               BorderBrush="#0288D1"
                               BorderThickness="1"
                               CornerRadius="5"
                               Padding="10"
                               Margin="0,20,0,0">
                            <StackPanel>
                                <TextBlock Text="â„¹ï¸ Important Notes:"
                                          FontWeight="Bold"
                                          Margin="0,0,0,5"/>
                                <TextBlock TextWrapping="Wrap" FontSize="11">
                                    â€¢ API keys are encrypted using Windows DPAPI<LineBreak/>
                                    â€¢ Queries are sent to OpenAI/Azure for analysis<LineBreak/>
                                    â€¢ Typical cost: $0.01-0.05 per query analysis<LineBreak/>
                                    â€¢ After saving, restart the app for changes to take effect<LineBreak/>
                                    â€¢ For more info, see AI_QUERY_OPTIMIZER_GUIDE.md
                                </TextBlock>
                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Border>

            </StackPanel>
        </ScrollViewer>
    </Grid>
</UserControl>


